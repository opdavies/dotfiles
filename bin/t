#!/usr/bin/env bash

set -o nounset
set -o pipefail

if [[ $# -eq 1 ]]; then
  selected=$1
else
  selected=$(zoxide query -l | grep -v /tmp | grep -v "^${HOME}/\." | grep -v "^${HOME}/Code$" | grep -v "/main$"  | fzf --reverse)
fi

if [[ -z "${selected}" ]]; then
  exit 0
fi

session_name=$(basename "${selected}" | sed 's/\./-/g')

if tmux has-session -t="${session_name}" 2> /dev/null; then
  exec tmux attach -t "${session_name}"
fi

# If a .tmux file exists within the selected directory, run it with the
# generated session name.
if [[ -e "${selected}/main" ]] && [[ -e "${selected}/main/.tmux" ]]; then
  "${selected}/main/.tmux" "${session_name}" "${selected}/main"
  exit
elif [[ -e "${selected}/.tmux" ]]; then
  "${selected}/.tmux" "${session_name}" "${selected}"
  exit
fi

tmux_running=$(pgrep tmux)

# if [[ -z "${TMUX:-}" ]] && [[ -z "${tmux_running}" ]]; then
#   if [[ -e "${selected}/main" ]]; then
#     tmux new-session -d -s "${session_name}" -d -s "${session_name}" -c "${selected}/main"
#   else
#     tmux new-session -d -s "${session_name}" -d -s "${session_name}" -c "${selected}"
#   fi
#   exit 0
# fi

if ! tmux has-session -t="${session_name}" 2> /dev/null; then
  if [[ -e "${selected}/main" ]]; then
    tmux new-session -d -s "${session_name}" -d -s "${session_name}" -c "${selected}/main"
  else
    tmux new-session -d -s "${session_name}" -d -s "${session_name}" -c "${selected}"
  fi
fi

exec tmux switch-client -t "${session_name}"
